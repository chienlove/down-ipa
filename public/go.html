<!-- public/go.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đang chuẩn bị…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .card { max-width: 520px; }
    .count { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen">
  <div class="mx-auto card mt-10 bg-white rounded-xl shadow p-6 text-center">
    <h1 class="text-2xl font-bold mb-2">⏳ Đang chuẩn bị liên kết</h1>
    <p class="text-gray-600 mb-4">Vui lòng chờ đếm ngược kết thúc để tiếp tục.</p>

    <!-- Vòng tròn đếm ngược 10s -->
    <div class="relative w-32 h-32 mx-auto mb-6">
      <svg class="w-full h-full" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"></circle>
        <circle id="progressCircle"
          cx="50" cy="50" r="45"
          fill="none" stroke="#22c55e" stroke-width="8"
          stroke-linecap="round"
          transform="rotate(-90 50 50)"
          stroke-dasharray="282.743" stroke-dashoffset="0">
        </circle>
      </svg>
      <span id="countdownNum" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold text-gray-800">
        10
      </span>
    </div>

    <div id="info" class="bg-blue-50 border border-blue-200 text-blue-900 rounded px-4 py-3 mb-4 text-sm">
      <div id="typeLabel" class="font-medium"></div>
      <div class="mt-1">
        <span id="hint">Liên kết sẽ sẵn sàng sau <span id="secs" class="count font-semibold">10</span>s…</span>
        <span id="expiry" class="hidden">Liên kết hết hạn sau: <span id="exp" class="font-semibold">—</span>s</span>
      </div>
    </div>

    <a id="actionBtn" href="#" target="_self" rel="noopener"
       class="w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-gray-400 cursor-not-allowed">
      <i class="fa-solid fa-circle-notch fa-spin mr-2"></i>
      Đang chuẩn bị…
    </a>

    <p class="text-xs text-gray-500 mt-4">Nếu nút không hoạt động, hãy thử làm mới trang hoặc kiểm tra trình chặn pop-up.</p>

    <div class="mt-6 flex justify-center">
      <a href="/" class="text-sm text-gray-600 hover:text-gray-800">← Quay về trang chính</a>
    </div>
  </div>

  <script>
    // Lọc URL an toàn
    function isSafeUrl(u) {
      try {
        const parsed = new URL(u);
        const p = parsed.protocol.toLowerCase();
        return p === 'https:' || p === 'itms-services:';
      } catch { return false; }
    }

    const params      = new URLSearchParams(location.search);
    const type        = (params.get('type') || '').toLowerCase();          // download | install
    const targetUrl   = decodeURIComponent(params.get('url')   || '');
    const rawPlistUrl = decodeURIComponent(params.get('plist') || '');     // chỉ có khi type=install
    const expSeconds  = parseInt(params.get('exp') || '300', 10);          // hết hạn link (server đang xóa sau 5p)

    const typeLabel   = document.getElementById('typeLabel');
    const actionBtn   = document.getElementById('actionBtn');
    const secs        = document.getElementById('secs');
    const hint        = document.getElementById('hint');
    const expiry      = document.getElementById('expiry');
    const exp         = document.getElementById('exp');
    const circle      = document.getElementById('progressCircle');
    const countdownEl = document.getElementById('countdownNum');

    // Label
    if (type === 'download') typeLabel.textContent = 'Chuẩn bị tải file IPA…';
    else if (type === 'install') typeLabel.textContent = 'Chuẩn bị cài đặt trực tiếp…';
    else typeLabel.textContent = 'Yêu cầu không hợp lệ.';

    // Validate params
    if (!type || !targetUrl || !isSafeUrl(targetUrl)) {
      secs.textContent = '0';
      countdownEl.textContent = '0';
      actionBtn.textContent = 'Yêu cầu không hợp lệ';
      actionBtn.className = 'w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-red-500';
      actionBtn.href = '#';
    } else {
      // Đếm ngược 10s
      let n = 10;
      const radius = 45;
      const circumference = 2 * Math.PI * radius;

      function setProgress(t) {
        // t từ 10 -> 0
        const ratio = Math.max(0, Math.min(10, t)) / 10;
        circle.setAttribute('stroke-dasharray', circumference.toFixed(3));
        circle.setAttribute('stroke-dashoffset', (circumference * (1 - ratio)).toFixed(3));
      }

      secs.textContent = String(n);
      countdownEl.textContent = String(n);
      setProgress(n);

      const t = setInterval(() => {
        n -= 1;
        secs.textContent = String(n);
        countdownEl.textContent = String(n);
        setProgress(n);
        if (n <= 0) {
          clearInterval(t);

          // Hiện trạng thái “hết hạn sau …s”
          hint.classList.add('hidden');
          expiry.classList.remove('hidden');
          let remain = isFinite(expSeconds) ? expSeconds : 300;
          exp.textContent = remain;

          const expireTimer = setInterval(() => {
            remain -= 1;
            if (remain <= 0) {
              clearInterval(expireTimer);
              exp.textContent = '0';
              actionBtn.className = 'w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-gray-400 cursor-not-allowed';
              actionBtn.innerHTML = '<i class="fa-solid fa-ban mr-2"></i> Liên kết đã hết hạn';
              actionBtn.href = '#';
            } else {
              exp.textContent = remain;
            }
          }, 1000);

          // Kích hoạt nút
          if (type === 'download') {
            actionBtn.innerHTML = '<i class="fa-solid fa-download mr-2"></i> Tải file IPA';
            actionBtn.className = 'w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-blue-600 hover:bg-blue-700';
            actionBtn.href = targetUrl;
          } else if (type === 'install') {
            actionBtn.innerHTML = '<i class="fa-solid fa-mobile-screen mr-2"></i> Cài đặt';
            actionBtn.className = 'w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-green-600 hover:bg-green-700';
            actionBtn.href = '#';

            actionBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              // Nếu có rawPlistUrl thì HEAD check trước
              if (rawPlistUrl && isSafeUrl(rawPlistUrl)) {
                try {
                  const resp = await fetch(rawPlistUrl, { method: 'HEAD' });
                  if (!resp.ok) {
                    if (resp.status === 403) alert('Liên kết đã hết hạn. Vui lòng tải lại.');
                    else if (resp.status === 404) alert('Không tìm thấy file cài đặt.');
                    else alert('Không thể xác minh liên kết cài đặt.');
                    return;
                  }
                } catch (err) {
                  // Nếu CORS chặn HEAD, vẫn cho tiếp tục như fallback
                  console.warn('HEAD check error, continue anyway:', err);
                }
              }
              // Điều hướng sang itms-services
              location.href = targetUrl;
            }, { once: true });
          } else {
            actionBtn.innerHTML = 'Yêu cầu không hợp lệ';
            actionBtn.className = 'w-full inline-flex items-center justify-center px-4 py-3 rounded-lg text-white bg-red-500';
            actionBtn.href = '#';
          }
        }
      }, 1000);
    }
  </script>
</body>
</html>